<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shop Key Game</title>

    <!-- Bootstrap & SweetAlert2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: #0f172a;
        color: #e2e8f0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .container-narrow {
        max-width: 880px;
      }
      .card {
        background: #0b1220;
        border: 1px solid #1f2a44;
        border-radius: 14px;
      }
      .game-card {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 16px;
        padding: 12px;
        border: 1px solid #1f2a44;
        border-radius: 14px;
        background: #0b1220;
        margin-bottom: 14px;
      }
      .game-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #1f2a44;
      }
      .game-title {
        margin: 0 0 8px;
        color: #e2e8f0;
      }
      .game-btn {
        margin-right: 8px;
        margin-bottom: 8px;
      }
      .form-label {
        color: #cbd5e1;
      }
      .text-muted {
        color: #94a3b8 !important;
      }
      .btn-success {
        background: #16a34a;
        border: 0;
      }
      .btn-primary {
        background: #3b82f6;
        border: 0;
      }
      .bank-badge {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid #1f2a44;
        border-radius: 10px;
        margin-right: 6px;
        margin-bottom: 6px;
        font-size: 12px;
        color: #cbd5e1;
        background: #0b1220;
      }
      .small-dim {
        color: #93a4c0;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container container-narrow py-4">
      <header class="mb-4">
        <h1 class="h4 mb-1">Shop Key Game</h1>
        <div class="text-muted">Thanh to√°n QR ‚Ä¢ Nh·∫≠n key nhanh</div>
      </header>

      <section class="mb-4">
        <h2 class="h6 mb-3">Game / ·ª®ng d·ª•ng</h2>
        <div id="gameList"></div>
      </section>

      <section class="mb-5">
        <div class="card p-3">
          <form id="orderForm" class="row gy-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="game">Ch·ªçn game</label>
              <select id="game" class="form-select">
                <option value="">-- Ch·ªçn --</option>
                <option value="Li√™n Qu√¢n Mobile ADR">Li√™n Qu√¢n Mobile ADR</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="duration">Th·ªùi h·∫°n</label>
              <select id="duration" class="form-select">
                <option value="">-- Ch·ªçn --</option>
                <option value="1day">1 ng√†y (2.000ƒë)</option>
                <option value="7day">7 ng√†y (40.000ƒë)</option>
                <option value="30day">30 ng√†y (100.000ƒë)</option>
                <option value="60day">60 ng√†y (180.000ƒë)</option>
                <option value="90day">90 ng√†y (240.000ƒë)</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="bankApp">Ch·ªçn ng√¢n h√†ng</label>
              <select id="bankApp" class="form-select">
                <option value="mb">MB Bank (khuy·∫øn ngh·ªã)</option>
                <option value="vcb">Vietcombank</option>
                <option value="bidv">BIDV</option>
                <option value="tcb">Techcombank</option>
                <option value="acb">ACB</option>
                <option value="vpb">VPBank</option>
                <option value="vtb">VietinBank</option>
                <option value="tpb">TPBank</option>
                <option value="scb">Sacombank</option>
                <option value="agb">Agribank</option>
              </select>
              <div class="small-dim mt-2">
                H·ªá th·ªëng s·∫Ω th·ª≠ m·ªü tr·ª±c ti·∫øp app. N·∫øu kh√¥ng ƒë∆∞·ª£c, h√£y d√πng n√∫t/fallback ho·∫∑c qu√©t QR.
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="discountCode">M√£ gi·∫£m gi√°</label>
              <input id="discountCode" class="form-control" placeholder="GIAM10 / GIAM20" />
            </div>

            <div class="col-12 d-flex align-items-end">
              <button type="button" id="paymentButton" class="btn btn-success">
                Ti·∫øp t·ª•c thanh to√°n
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- MODAL THANH TO√ÅN -->
      <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div
            class="modal-content"
            style="background: #0b1220; color: #e2e8f0; border: 1px solid #1f2a44"
          >
            <div class="modal-header">
              <h5 class="modal-title">Thanh to√°n & X√°c nh·∫≠n</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <div id="resultBox" class="mb-3"></div>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card p-3">
                    <div class="mb-2">
                      <div class="text-muted small">M√£ giao d·ªãch</div>
                      <div class="d-flex align-items-center">
                        <div id="note" class="me-2 fw-semibold"></div>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-light copy-btn"
                          data-target="note"
                        >
                          Copy
                        </button>
                      </div>
                    </div>

                    <div class="mb-2">
                      <div class="text-muted small">S·∫£n ph·∫©m</div>
                      <div id="product" class="fw-semibold"></div>
                    </div>

                    <div class="mb-3">
                      <div class="text-muted small">S·ªë ti·ªÅn</div>
                      <div id="amount" class="fw-semibold"></div>
                    </div>

                    <div>
                      <div class="text-muted small">Ng√¢n h√†ng</div>
                      <div id="bankLabel" class="fw-semibold"></div>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card p-3 text-center">
                    <div class="mb-2">Qu√©t QR ƒë·ªÉ thanh to√°n</div>
                    <img
                      id="qrImage"
                      alt="QR"
                      style="max-width: 100%; border-radius: 8px; border: 1px solid #1f2a44"
                    />
                    <div class="mt-2 d-grid gap-2">
                      <a
                        id="paymentLink"
                        class="btn btn-outline-info btn-sm"
                        target="_blank"
                        rel="noopener"
                      >
                        M·ªü b·∫±ng app ƒë√£ ch·ªçn
                      </a>
                      <button id="retryOpenApp" class="btn btn-outline-light btn-sm" type="button">
                        Th·ª≠ m·ªü l·∫°i app
                      </button>
                      <div class="small-dim">
                        N·∫øu ·ª©ng d·ª•ng kh√¥ng m·ªü, vui l√≤ng d√πng n√∫t tr√™n ho·∫∑c qu√©t QR.
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <span class="bank-badge">B·∫£o l∆∞u QR ƒë·ªÉ d√πng l·∫°i trong 5 ph√∫t</span>
                <span class="bank-badge">N·ªôi dung chuy·ªÉn kho·∫£n = M√£ giao d·ªãch</span>
                <span class="bank-badge">Sai s·ªë ti·ªÅn ho·∫∑c sai n·ªôi dung c√≥ th·ªÉ ch·∫≠m x·ª≠ l√Ω</span>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" id="confirmBtn" class="btn btn-primary">
                T√¥i ƒë√£ thanh to√°n
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      </div>

      <footer class="small text-muted mt-4">
        ¬© <span id="year"></span> Shop Key Game
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /*************** C·∫§U H√åNH T√ÄI KHO·∫¢N & NG√ÇN H√ÄNG ***************/
        // S·ªë t√†i kho·∫£n nh·∫≠n ti·ªÅn
        const ACCOUNT_NO = "075020699999";
        const ACCOUNT_BANK_CODE = "MBBank";
        const BANK_DISPLAY = {
          mb: "MB Bank",
          vcb: "Vietcombank",
          bidv: "BIDV",
          tcb: "Techcombank",
          acb: "ACB",
          vpb: "VPBank",
          vtb: "VietinBank",
          tpb: "TPBank",
          scb: "Sacombank",
          agb: "Agribank",
        };
        const VIETQR_APP = {
          mb: "mb",
          vcb: "vcb",
          bidv: "bidv",
          tcb: "techcombank",
          acb: "acb",
          vpb: "vpbank",
          vtb: "vietinbank",
          tpb: "tpbank",
          scb: "sacombank",
          agb: "agribank",
        };
        const MB_ANDROID_PKG = "com.mbmobile";

        const games = [
          {
            title: "Li√™n Qu√¢n Mobile ADR",
            image:
              "https://cdn-media.sforum.vn/storage/app/media/wp-content/uploads/2023/07/THUMB.jpg",
            links: [
              {
                text: "T·∫£i t√°ch g·ªëc",
                url: "https://www.mediafire.com/file/z8tqbiufur3uely/MAP2.9+FIX+V%C4%82NG+_+T%C3%81CH.apk/file",
              },
              {
                text: "T·∫£i x√≥a g·ªëc",
                url: "https://www.mediafire.com/file/28o2ln5md8h1oml/2.9+FIX+CRASH+(+L%E1%BA%A6N+2).apk/file",
              },
              {
                text: "T·∫£i IPA IOS",
                url: "https://chaptodocquyen.appinstall.cloud/aovcheatipa.ipa",
              { text: "L·∫•y Key Free", url: "https://link4m.com/hP9L1U" },
            ],
          },
        ];

        const discountCodes = {
          GIAM10: { value: 0.1, description: "Gi·∫£m 10%" },
          GIAM20: { value: 0.2, description: "Gi·∫£m 20%" },
        };

        const priceConfig = {
          "1day": { amount: 2000, display: "1 ng√†y" },
          "7day": { amount: 40000, display: "7 ng√†y" },
          "30day": { amount: 100000, display: "30 ng√†y" },
          "60day": { amount: 180000, display: "60 ng√†y" },
          "90day": { amount: 240000, display: "90 ng√†y" },
        };

        /******************** TI·ªÜN √çCH ********************/
        const el = (id) => document.getElementById(id);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

        const state = {
          modal: null,
          transaction: null,
          processing: false,
        };

        const showAlert = (icon, title, html) =>
          Swal.fire({ icon, title, html, confirmButtonColor: "#16a34a" });

        const showToast = (msg) =>
          Swal.fire({
            icon: "success",
            title: msg,
            toast: true,
            position: "top-end",
            timer: 2000,
            showConfirmButton: false,
          });

        const applyDiscount = (code, amount) => {
          const dc = discountCodes[code];
          if (!dc)
            return {
              final: amount,
              msg: code ? `‚ö†Ô∏è M√£ gi·∫£m gi√° "${code}" kh√¥ng h·ª£p l·ªá.` : "",
            };
          const final = Math.max(0, Math.round(amount * (1 - dc.value)));
          return {
            final,
            msg: `‚úÖ M√£ gi·∫£m gi√° "${code}" (${dc.description}) ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng.`,
          };
        };

        const renderGames = () => {
          const container = el("gameList");
          container.innerHTML = games
            .map(
              (game) => `
              <div class="game-card">
                <img src="${game.image}" alt="${
                  game.title
                }" class="game-image" onerror="this.src='https://via.placeholder.com/180?text=Image+Not+Found'">
                <div class="game-content">
                  <h4 class="game-title">${game.title}</h4>
                  ${game.links
                    .map(
                      (link) =>
                        `<a href="${link.url}" ${
                          link.url !== "#" ? 'target="_blank"' : ""
                        } class="btn btn-primary game-btn">${link.text}</a>`
                    )
                    .join("")}
                </div>
              </div>`
            )
            .join("");
        };

        /******************** DEEPLINK BUILDER ********************/
        // Link web MBBank (c√≥ th·ªÉ l√† universal link tr√™n iOS)
        const buildMBWeb = (amount, code) =>
          `https://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=${ACCOUNT_NO}&amount=${amount}&content=${encodeURIComponent(
            code
          )}`;

        // Android Intent m·ªü th·∫≥ng app MB
        const buildMBIntent = (amount, code) =>
          `intent://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=${ACCOUNT_NO}&amount=${amount}&content=${encodeURIComponent(
            code
          )}#Intent;scheme=https;package=${MB_ANDROID_PKG};end`;

        // VietQR Deeplink: ƒëi·ªÅu h∆∞·ªõng t·ªõi app ng√¢n h√†ng t∆∞∆°ng ·ª©ng (n·∫øu h·ªó tr·ª£)
        // L∆∞u √Ω: n·∫øu app ch∆∞a c√†i, c√≥ th·ªÉ kh√¥ng m·ªü ƒë∆∞·ª£c ‚Äî UI ƒë√£ c√≥ QR v√† n√∫t m·ªü l·∫°i.
        const buildVietQRLink = (appCode, amount, code) =>
          `https://dl.vietqr.io/pay?app=${appCode}&acc=${ACCOUNT_NO}&amount=${amount}&note=${encodeURIComponent(
            code
          )}`;

        // ·∫¢nh QR (m√£ n·ªôi dung: code, s·ªë ti·ªÅn: amount)
        // B·∫°n c√≥ th·ªÉ ƒë·ªïi sang img.vietqr.io n·∫øu mu·ªën.
        const buildQRImage = (amount, code) =>
          `https://qr.sepay.vn/img?acc=${ACCOUNT_NO}&bank=${encodeURIComponent(
            ACCOUNT_BANK_CODE
          )}&amount=${amount}&des=${encodeURIComponent(
            code
          )}&template=compact`;

        // Nh√£n ƒë·∫πp cho ng√¢n h√†ng
        const labelOfBank = (bankKey) => BANK_DISPLAY[bankKey] || "Ng√¢n h√†ng kh√°c";

        // M·ªü app theo l·ª±a ch·ªçn ng∆∞·ªùi d√πng
        function openBankApp({ bankKey, amount, code, auto = false }) {
          const a = el("paymentLink");
          let href = "#";

          if (bankKey === "mb") {
            const baseWeb = buildMBWeb(amount, code);
            const androidIntent = buildMBIntent(amount, code);
            href = baseWeb; // ƒë·∫∑t cho n√∫t

            if (auto && (isAndroid || isIOS)) {
              if (isAndroid) {
                // Th·ª≠ Intent -> fallback web
                window.location.href = androidIntent;
                setTimeout(() => {
                  try {
                    window.location.href = baseWeb;
                  } catch (_) {}
                }, 1200);
              } else {
                // iOS: m·ªü universal link (n·∫øu app h·ªó tr·ª£ s·∫Ω v√†o app, n·∫øu kh√¥ng th√¨ web)
                window.location.href = baseWeb;
              }
            }
          } else {
            const appCode = VIETQR_APP[bankKey] || "mb";
            const vietqr = buildVietQRLink(appCode, amount, code);
            href = vietqr;

            if (auto && (isAndroid || isIOS)) {
              // Th·ª≠ m·ªü app qua VietQR deeplink
              window.location.href = vietqr;
              // Kh√¥ng b·∫Øt bu·ªôc fallback ·ªü ƒë√¢y v√¨ ng∆∞·ªùi d√πng v·∫´n ƒëang ·ªü modal v√† c√≥ QR s·∫µn
            }
          }

          a.href = href; // lu√¥n g√°n ƒë·ªÉ user c√≥ th·ªÉ b·∫•m l·∫°i
        }

        /******************** UI C·∫¨P NH·∫¨T MODAL ********************/
        function updateModal({ code, product, amount, bankKey, message }) {
          el("note").textContent = code;
          el("product").textContent = product;
          el("amount").textContent = amount.toLocaleString("vi-VN") + " VNƒê";
          el("bankLabel").textContent = labelOfBank(bankKey);

          // Set QR image
          el("qrImage").src = buildQRImage(amount, code);

          // Th√¥ng b√°o √°p m√£ gi·∫£m gi√° (n·∫øu c√≥)
          el("resultBox").innerHTML = message
            ? `<div class="alert alert-${
                amount === 0 ? "warning" : "success"
              }">${message}</div>`
            : "";
          openBankApp({ bankKey, amount, code, auto: false });
        }
        function handlePayment() {
          if (state.processing) return;
          state.processing = true;

          const game = el("game")?.value;
          const duration = el("duration")?.value;
          const bankKey = el("bankApp")?.value || "mb";
          const discountCode = el("discountCode")?.value.trim().toUpperCase();
          const config = priceConfig[duration];

          if (!game || !config) {
            showAlert("error", "Thi·∫øu th√¥ng tin!", "Vui l√≤ng ch·ªçn game v√† th·ªùi h·∫°n.");
            state.processing = false;
            return;
          }

          const discountResult = applyDiscount(discountCode, config.amount);
          const transCode = "DXK" + Math.floor(1000 + Math.random() * 9000);
          const product = `${config.display} | ${game}`;

          state.transaction = {
            code: transCode,
            product,
            amount: discountResult.final,
            bankKey,
          };
          updateModal({
            code: transCode,
            product,
            amount: discountResult.final,
            bankKey,
            message: discountResult.msg,
          });

          state.modal.show();
          openBankApp({
            bankKey,
            amount: discountResult.final,
            code: transCode,
            auto: true,
          });

          state.processing = false;
        }

        function confirmPayment() {
          if (!state.transaction || state.processing) return;
          state.processing = true;

          showAlert(
            "success",
            "üéâ Thanh to√°n th√†nh c√¥ng!",
            `M√£ giao d·ªãch: <strong>${state.transaction.code}</strong><br>Li√™n h·ªá admin ƒë·ªÉ l·∫•y key nh√©!`
          );

          el("resultBox").innerHTML =
            '<div class="alert alert-success">‚úÖ ƒê√£ x√°c nh·∫≠n thanh to√°n. Vui l√≤ng ƒë·ª£i admin x·ª≠ l√Ω.</div>';
          el("confirmBtn").disabled = true;

          setTimeout(() => {
            el("orderForm").reset();
            state.modal.hide();
            el("confirmBtn").disabled = false;
            state.transaction = null;
            state.processing = false;
            el("resultBox").innerHTML = "";
          }, 5000);
        }

        function handleCopy(e) {
          const btn = e.target.closest(".copy-btn");
          if (!btn) return;
          const textToCopy = btn.dataset.text || el(btn.dataset.target)?.textContent;
          if (!textToCopy) return;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(textToCopy)
              .then(() => showToast("ƒê√£ sao ch√©p!"))
              .catch((err) => {
                console.error("Failed to copy text: ", err);
                showAlert(
                  "error",
                  "L·ªói sao ch√©p!",
                  "Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " + textToCopy
                );
              });
          } else {
            const textarea = document.createElement("textarea");
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand("copy");
              showToast("ƒê√£ sao ch√©p!");
            } catch (err) {
              console.error("Fallback copy failed: ", err);
              showAlert(
                "error",
                "L·ªói sao ch√©p!",
                "Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " + textToCopy
              );
            }
            document.body.removeChild(textarea);
          }
        }

        function retryOpen() {
          if (!state.transaction) return;
          openBankApp({
            bankKey: state.transaction.bankKey,
            amount: state.transaction.amount,
            code: state.transaction.code,
            auto: true,
          });
        }
        renderGames();
        document.getElementById("year").textContent = new Date().getFullYear();

        state.modal = new bootstrap.Modal(el("paymentModal"));
        el("paymentButton").addEventListener("click", handlePayment);
        el("confirmBtn").addEventListener("click", confirmPayment);
        el("retryOpenApp").addEventListener("click", retryOpen);
        document.addEventListener("click", handleCopy);
        const form = document.getElementById("orderForm");
        if (form) form.addEventListener("submit", (e) => e.preventDefault());
      });
    </script>
  </body>
</html>
