<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shop Key Game</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: #0f172a;
        color: #e2e8f0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .container-narrow {
        max-width: 880px;
      }
      .card {
        background: #0b1220;
        border: 1px solid #1f2a44;
        border-radius: 14px;
      }

      .game-title {
        margin: 0 0 8px;
        color: #e2e8f0;
      }
      .game-btn {
        margin-right: 8px;
        margin-bottom: 8px;
      }
      .form-label {
        color: #cbd5e1;
      }
      .text-muted {
        color: #94a3b8 !important;
      }
      .btn-success {
        background: #16a34a;
        border: 0;
      }
      .btn-primary {
        background: #3b82f6;
        border: 0;
      }
      .bank-badge {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid #1f2a44;
        border-radius: 10px;
        margin-right: 6px;
        margin-bottom: 6px;
        font-size: 12px;
        color: #cbd5e1;
        background: #0b1220;
      }
      .small-dim {
        color: #93a3b8;
        font-size: 12px;
      }
      /* ·∫¢nh n·ªÅn t·∫£ng nh·ªè (Android / iOS) */
      .platform-image {
        width: 120px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #1f2a44;
      }
      .platform-block {
        align-items: flex-start !important;
      }
    </style>
  </head>
  <body>
    <div class="container container-narrow py-4">
      <header class="mb-4">
        <h1 class="h4 mb-1">Shop Key Game</h1>
        <div class="text-muted">Thanh to√°n QR ‚Ä¢ Nh·∫≠n key nhanh</div>
      </header>

      <section class="mb-4">
        <h2 class="h6 mb-3">Game / ·ª®ng d·ª•ng</h2>
        <div id="gameList"></div>
      </section>

      <section class="mb-5">
        <div class="card p-3">
          <form id="orderForm" class="row gy-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="game">Ch·ªçn game</label>
              <select id="game" class="form-select">
                <option value="">-- Ch·ªçn --</option>
                <option value="Li√™n Qu√¢n Mobile (Android)">Li√™n Qu√¢n Mobile (Android)</option>
                <option value="Li√™n Qu√¢n Mobile (iOS)">Li√™n Qu√¢n Mobile (iOS)</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="duration">Th·ªùi h·∫°n</label>
              <select id="duration" class="form-select">
                <option value="">-- Ch·ªçn --</option>
                <option value="1day">1 ng√†y (4.000ƒë)</option>
                <option value="7day">7 ng√†y (50.000ƒë)</option>
                <option value="30day">30 ng√†y (100.000ƒë)</option>
                <option value="60day">60 ng√†y (180.000ƒë)</option>
                <option value="90day">90 ng√†y (240.000ƒë)</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="bankApp">Ch·ªçn ng√¢n h√†ng</label>
              <select id="bankApp" class="form-select">
                <option value="mb">MB Bank (khuy·∫øn ngh·ªã)</option>
                <option value="vcb">Vietcombank</option>
                <option value="bidv">BIDV</option>
                <option value="tcb">Techcombank</option>
                <option value="acb">ACB</option>
                <option value="vpb">VPBank</option>
                <option value="vtb">VietinBank</option>
                <option value="tpb">TPBank</option>
                <option value="scb">Sacombank</option>
                <option value="agb">Agribank</option>
              </select>
              <div class="small-dim mt-2">
                H·ªá th·ªëng s·∫Ω t·∫°o QR k√®m n·ªôi dung chuy·ªÉn kho·∫£n. B·∫°n ch·ªâ c·∫ßn thanh to√°n ƒë√∫ng n·ªôi dung v√† s·ªë ti·ªÅn.
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="discountCode">M√£ gi·∫£m gi√°</label>
              <input id="discountCode" class="form-control" placeholder="GIAM10" />
            </div>

            <div class="col-12 d-flex align-items-end">
              <button type="button" id="paymentButton" class="btn btn-success">
                Ti·∫øp t·ª•c thanh to√°n
              </button>
            </div>
          </form>
        </div>
      </section>

      <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div
            class="modal-content"
            style="background: #0b1220; color: #e2e8f0; border: 1px solid #1f2a44"
          >
            <div class="modal-header">
              <h5 class="modal-title">Thanh to√°n & X√°c nh·∫≠n</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <div id="resultBox" class="mb-3"></div>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card p-3">
                    <div class="mb-2">
                      <div class="text-muted small">M√£ giao d·ªãch</div>
                      <div class="d-flex align-items-center">
                        <div id="note" class="me-2 fw-semibold"></div>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-light copy-btn"
                          data-target="note"
                        >
                          Copy
                        </button>
                      </div>
                    </div>

                    <div class="mb-2">
                      <div class="text-muted small">S·∫£n ph·∫©m</div>
                      <div id="product" class="fw-semibold"></div>
                    </div>

                    <div class="mb-3">
                      <div class="text-muted small">S·ªë ti·ªÅn</div>
                      <div id="amount" class="fw-semibold"></div>
                    </div>

                    <div>
                      <div class="text-muted small">Ng√¢n h√†ng</div>
                      <div id="bankLabel" class="fw-semibold"></div>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card p-3 text-center">
                    <div class="mb-2">Qu√©t QR ƒë·ªÉ thanh to√°n</div>
                    <img
                      id="qrImage"
                      alt="QR"
                      style="max-width: 100%; border-radius: 8px; border: 1px solid #1f2a44"
                    />
                    <div class="mt-2 d-grid gap-2">
                      <a
                        id="paymentLink"
                        class="btn btn-outline-info btn-sm"
                        target="_blank"
                        rel="noopener"
                      >
                        M·ªü link thanh to√°n
                      </a>
                      <button id="retryOpenApp" class="btn btn-outline-light btn-sm" type="button">
                        Th·ª≠ m·ªü l·∫°i link
                      </button>
                      <div class="small-dim">
                        N·∫øu ·ª©ng d·ª•ng kh√¥ng m·ªü, vui l√≤ng d√πng n√∫t tr√™n ho·∫∑c qu√©t QR.
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <span class="bank-badge">B·∫£o l∆∞u QR ƒë·ªÉ d√πng l·∫°i trong 5 ph√∫t</span>
                <span class="bank-badge">N·ªôi dung chuy·ªÉn kho·∫£n = M√£ giao d·ªãch</span>
                <span class="bank-badge">Sai s·ªë ti·ªÅn ho·∫∑c sai n·ªôi dung c√≥ th·ªÉ ch·∫≠m x·ª≠ l√Ω</span>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" id="confirmBtn" class="btn btn-primary">
                T√¥i ƒë√£ thanh to√°n
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      </div>

      <footer class="small text-muted mt-4">
        ¬© <span id="year"></span> Shop Key Game
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /*************** C·∫§U H√åNH T√ÄI KHO·∫¢N & NG√ÇN H√ÄNG ***************/
        // S·ªë t√†i kho·∫£n nh·∫≠n ti·ªÅn
        const ACCOUNT_NO = "075020699999";
        const ACCOUNT_BANK_CODE = "MBBank";

        const BANK_DISPLAY = {
          mb: "MB Bank",
          vcb: "Vietcombank",
          bidv: "BIDV",
          tcb: "Techcombank",
          acb: "ACB",
          vpb: "VPBank",
          vtb: "VietinBank",
          tpb: "TPBank",
          scb: "Sacombank",
          agb: "Agribank",
        };
        const VIETQR_APP = {
          mb: "mb",
          vcb: "vcb",
          bidv: "bidv",
          tcb: "techcomcombank", // c√≥ th·ªÉ ƒë·ªïi n·∫øu app code kh√°c
          acb: "acb",
          vpb: "vpbank",
          vtb: "vietinbank",
          tpb: "tpbank",
          scb: "sacombank",
          agb: "agribank",
        };
        const MB_ANDROID_PKG = "com.mbmobile";

        const games = [
          {
            title: "Li√™n Qu√¢n Mobile",
            androidImage:
              "https://cdn-media.sforum.vn/storage/app/media/wp-content/uploads/2023/07/THUMB.jpg",
            iosImage:
              "https://cdn-media.sforum.vn/storage/app/media/wp-content/uploads/2023/07/THUMB.jpg",

            androidLinks: [
              {
                text: "T·∫£i t√°ch g·ªëc (Android/ADR)",
                url: "https://www.mediafire.com/file/z8tqbiufur3uely/MAP2.9+FIX+V%C4%82NG+_+T%C3%81CH.apk/file",
              },
              {
                text: "T·∫£i x√≥a g·ªëc (Android/ADR)",
                url: "https://www.mediafire.com/file/28o2ln5md8h1oml/2.9+FIX+CRASH+(+L%E1%BA%A6N+2).apk/file",
              },
              { text: "L·∫•y Key Free", url: "https://link4m.com/7eAhF" },
            ],
            iosLinks: [
              { text: "T·∫£i IPA iOS", url: "https://link4m.com/EyQspkb" },
              { text: "L·∫•y Key Free", url: "https://link4m.com/7eAhF" },
            ],
          },
        ];

        const discountCodes = {
          GIAM10: { value: 0.1, description: "Gi·∫£m 10%" },
        };

        const priceConfig = {
          "1day": { amount: 4000, display: "1 ng√†y" },
          "7day": { amount: 50000, display: "7 ng√†y" },
          "30day": { amount: 100000, display: "30 ng√†y" },
          "60day": { amount: 180000, display: "60 ng√†y" },
          "90day": { amount: 240000, display: "90 ng√†y" },
        };

        /******************** TI·ªÜN √çCH ********************/
        const el = (id) => document.getElementById(id);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

        const state = {
          modal: null,
          transaction: null,
          processing: false,
        };

        const showAlert = (icon, title, html) =>
          Swal.fire({ icon, title, html, confirmButtonColor: "#16a34a" });

        const showToast = (msg) =>
          Swal.fire({
            icon: "success",
            title: msg,
            toast: true,
            position: "top-end",
            timer: 2000,
            showConfirmButton: false,
          });

        const applyDiscount = (code, amount) => {
          const dc = discountCodes[code];
          if (!dc)
            return {
              final: amount,
              msg: code ? `‚ö†Ô∏è M√£ gi·∫£m gi√° "${code}" kh√¥ng h·ª£p l·ªá.` : "",
            };
          const final = Math.max(0, Math.round(amount * (1 - dc.value)));
          return {
            final,
            msg: `‚úÖ M√£ gi·∫£m gi√° "${code}" (${dc.description}) ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng.`,
          };
        };

        /******************** RENDER GAME LIST ********************/
        // ƒê√É XO√Å TH·∫∫ ·∫¢NH CHUNG C·ª¶A GAME. M·ªñI GAME GI·ªú CH·ªà HI·ªÇN TH·ªä TI√äU ƒê·ªÄ + C√ÅC BLOCK ANDROID / IOS
        const renderGames = () => {
          const container = el("gameList");
          container.innerHTML = games
            .map((game) => {
              const androidBlock = game.androidLinks?.length
                ? `
                  <div class="mt-2">
                    <div class="small text-muted mb-2">Android (ADR)</div>
                    <div class="d-flex gap-3 align-items-start platform-block">
                      <img
                        src="${game.androidImage || ""}"
                        alt="Android"
                        class="platform-image"
                        onerror="this.src='https://via.placeholder.com/120x80?text=Android'"
                      />
                      <div class="d-flex flex-wrap">
                        ${game.androidLinks
                          .map(
                            (link) => `
                              <a href="${link.url}" ${
                                link.url !== "#" ? 'target="_blank"' : ""
                              } class="btn btn-primary game-btn">${link.text}</a>
                            `
                          )
                          .join("")}
                      </div>
                    </div>
                  </div>
                `
                : "";

              const iosBlock = game.iosLinks?.length
                ? `
                  <div class="mt-3">
                    <div class="small text-muted mb-2">iOS</div>
                    <div class="d-flex gap-3 align-items-start platform-block">
                      <img
                        src="${game.iosImage || ""}"
                        alt="iOS"
                        class="platform-image"
                        onerror="this.src='https://via.placeholder.com/120x80?text=iOS'"
                      />
                      <div class="d-flex flex-wrap">
                        ${game.iosLinks
                          .map(
                            (link) => `
                              <a href="${link.url}" ${
                                link.url !== "#" ? 'target="_blank"' : ""
                              } class="btn btn-primary game-btn">${link.text}</a>
                            `
                          )
                          .join("")}
                      </div>
                    </div>
                  </div>
                `
                : "";

              return `
                <div class="card p-3 mb-3">
                  <h4 class="game-title">${game.title}</h4>
                  ${androidBlock}
                  ${iosBlock}
                </div>
              `;
            })
            .join("");
        };

        /******************** BUILD LINK / QR ********************/
        const buildMBWeb = (amount, code) =>
          `https://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=${ACCOUNT_NO}&amount=${amount}&content=${encodeURIComponent(
            code
          )}`;

        // Android Intent m·ªü th·∫≥ng app MB (gi·ªØ l·∫°i ƒë·ªÉ d√πng n·∫øu ng∆∞·ªùi d√πng b·∫•m n√∫t, nh∆∞ng KH√îNG t·ª± m·ªü n·ªØa)
        const buildMBIntent = (amount, code) =>
          `intent://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=${ACCOUNT_NO}&amount=${amount}&content=${encodeURIComponent(
            code
          )}#Intent;scheme=https;package=${MB_ANDROID_PKG};end`;

        // VietQR Deeplink
        const buildVietQRLink = (appCode, amount, code) =>
          `https://dl.vietqr.io/pay?app=${appCode}&acc=${ACCOUNT_NO}&amount=${amount}&note=${encodeURIComponent(
            code
          )}`;

        // ·∫¢nh QR
        const buildQRImage = (amount, code) =>
          `https://qr.sepay.vn/img?acc=${ACCOUNT_NO}&bank=${encodeURIComponent(
            ACCOUNT_BANK_CODE
          )}&amount=${amount}&des=${encodeURIComponent(
            code
          )}&template=compact`;

        // Nh√£n ng√¢n h√†ng
        const labelOfBank = (bankKey) =>
          BANK_DISPLAY[bankKey] || "Ng√¢n h√†ng kh√°c";

        // G√ÅN LINK THANH TO√ÅN CHO N√öT "M·ªü link thanh to√°n"
        function openBankApp({ bankKey, amount, code, auto = false }) {
          const a = el("paymentLink");
          let href = "#";

          if (bankKey === "mb") {
            const baseWeb = buildMBWeb(amount, code);
            const androidIntent = buildMBIntent(amount, code);
            href = baseWeb;

            // *** ƒê√É T·∫ÆT T·ª∞ ƒê·ªòNG M·ªû APP KHI ·∫§N THANH TO√ÅN ***
            // auto === true hi·ªán kh√¥ng d√πng n·ªØa
            if (auto && (isAndroid || isIOS)) {
              // KH√îNG g·ªçi window.location n·ªØa
            }
          } else {
            const appCode = VIETQR_APP[bankKey] || "mb";
            const vietqr = buildVietQRLink(appCode, amount, code);
            href = vietqr;

            if (auto && (isAndroid || isIOS)) {
              // KH√îNG t·ª± m·ªü app n·ªØa
            }
          }

          a.href = href;
        }

        /******************** UI C·∫¨P NH·∫¨T MODAL ********************/
        function updateModal({ code, product, amount, bankKey, message }) {
          el("note").textContent = code;
          el("product").textContent = product;
          el("amount").textContent =
            amount.toLocaleString("vi-VN") + " VNƒê";
          el("bankLabel").textContent = labelOfBank(bankKey);

          // Set QR image
          el("qrImage").src = buildQRImage(amount, code);

          // Th√¥ng b√°o √°p m√£ gi·∫£m gi√° (n·∫øu c√≥)
          el("resultBox").innerHTML = message
            ? `<div class="alert alert-${
                amount === 0 ? "warning" : "success"
              }">${message}</div>`
            : "";

          // Chu·∫©n b·ªã link m·ªü app/ng√¢n h√†ng (ch·ªâ ƒë·ªÉ ng∆∞·ªùi d√πng b·∫•m n·∫øu mu·ªën)
          openBankApp({ bankKey, amount, code, auto: false });
        }

        /******************** X·ª¨ L√ù THANH TO√ÅN (KH√îNG T·ª∞ M·ªû APP) ********************/
        function handlePayment() {
          if (state.processing) return;
          state.processing = true;

          const game = el("game")?.value;
          const duration = el("duration")?.value;
          const bankKey = el("bankApp")?.value || "mb";
          const discountCode = el("discountCode")?.value
            .trim()
            .toUpperCase();
          const config = priceConfig[duration];

          if (!game || !config) {
            showAlert(
              "error",
              "Thi·∫øu th√¥ng tin!",
              "Vui l√≤ng ch·ªçn game v√† th·ªùi h·∫°n."
            );
            state.processing = false;
            return;
          }

          const discountResult = applyDiscount(
            discountCode,
            config.amount
          );
          const transCode =
            "DXK" + Math.floor(1000 + Math.random() * 9000);
          const product = `${config.display} | ${game}`;

          state.transaction = {
            code: transCode,
            product,
            amount: discountResult.final,
            bankKey,
          };

          // C·∫≠p nh·∫≠t modal v·ªõi th√¥ng tin thanh to√°n
          updateModal({
            code: transCode,
            product,
            amount: discountResult.final,
            bankKey,
            message: discountResult.msg,
          });

          state.modal.show();

          state.processing = false;
        }

        /******************** X√ÅC NH·∫¨N ƒê√É CHUY·ªÇN KHO·∫¢N ********************/
        function confirmPayment() {
          if (!state.transaction || state.processing) return;
          state.processing = true;

          showAlert(
            "success",
            "üéâ Thanh to√°n th√†nh c√¥ng!",
            `M√£ giao d·ªãch: <strong>${state.transaction.code}</strong><br>Li√™n h·ªá admin ƒë·ªÉ l·∫•y key nh√©!`
          );

          el("resultBox").innerHTML =
            '<div class="alert alert-success">‚úÖ ƒê√£ x√°c nh·∫≠n thanh to√°n. Vui l√≤ng ƒë·ª£i admin x·ª≠ l√Ω.</div>';
          el("confirmBtn").disabled = true;

          setTimeout(() => {
            el("orderForm").reset();
            state.modal.hide();
            el("confirmBtn").disabled = false;
            state.transaction = null;
            state.processing = false;
            el("resultBox").innerHTML = "";
          }, 5000);
        }
        function handleCopy(e) {
          const btn = e.target.closest(".copy-btn");
          if (!btn) return;
          const textToCopy =
            btn.dataset.text ||
            el(btn.dataset.target)?.textContent;
          if (!textToCopy) return;

          if (
            navigator.clipboard &&
            navigator.clipboard.writeText
          ) {
            navigator.clipboard
              .writeText(textToCopy)
              .then(() => showToast("ƒê√£ sao ch√©p!"))
              .catch((err) => {
                console.error("Failed to copy text: ", err);
                showAlert(
                  "error",
                  "L·ªói sao ch√©p!",
                  "Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " +
                    textToCopy
                );
              });
          } else {
            const textarea = document.createElement("textarea");
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand("copy");
              showToast("ƒê√£ sao ch√©p!");
            } catch (err) {
              console.error("Fallback copy failed: ", err);
              showAlert(
                "error",
                "L·ªói sao ch√©p!",
                "Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " +
                  textToCopy
              );
            }
            document.body.removeChild(textarea);
          }
        }
        function retryOpen() {
          if (!state.transaction) return;
          openBankApp({
            bankKey: state.transaction.bankKey,
            amount: state.transaction.amount,
            code: state.transaction.code,
            auto: true, // v·∫´n cho ph√©p user b·∫•m n√∫t ƒë·ªÉ th·ª≠ m·ªü
          });
        }

        /******************** INIT ********************/
        renderGames();

        document.getElementById("year").textContent =
          new Date().getFullYear();

        state.modal = new bootstrap.Modal(el("paymentModal"));

        el("paymentButton").addEventListener(
          "click",
          handlePayment
        );
        el("confirmBtn").addEventListener(
          "click",
          confirmPayment
        );
        el("retryOpenApp").addEventListener(
          "click",
          retryOpen
        );
        document.addEventListener("click", handleCopy);

        const form = document.getElementById("orderForm");
        if (form)
          form.addEventListener("submit", (e) =>
            e.preventDefault()
          );
      });
    </script>
  </body>
</html>
