<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shop Key Game</title>

    <!-- Bootstrap & SweetAlert2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: #0f172a;
        color: #e2e8f0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }
      .container-narrow {
        max-width: 880px;
      }
      .card {
        background: #0b1220;
        border: 1px solid #1f2a44;
        border-radius: 14px;
      }
      .game-card {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 16px;
        padding: 12px;
        border: 1px solid #1f2a44;
        border-radius: 14px;
        background: #0b1220;
        margin-bottom: 14px;
      }
      .game-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #1f2a44;
      }
      .game-title {
        margin: 0 0 8px;
        color: #e2e8f0;
      }
      .game-btn {
        margin-right: 8px;
        margin-bottom: 8px;
      }
      .form-label {
        color: #cbd5e1;
      }
      .text-muted {
        color: #94a3b8 !important;
      }
      .btn-success {
        background: #16a34a;
        border: 0;
      }
      .btn-primary {
        background: #3b82f6;
        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="container container-narrow py-4">
      <header class="mb-4">
        <h1 class="h4 mb-1">Shop Key Game</h1>
        <div class="text-muted">Thanh to√°n QR ‚Ä¢ Nh·∫≠n key nhanh</div>
      </header>
      <section class="mb-4">
        <h2 class="h6 mb-3">Game / ·ª®ng d·ª•ng</h2>
        <div id="gameList"></div>
      </section>
      <section class="mb-5">
        <div class="card p-3">
          <form id="orderForm" class="row gy-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="game">Ch·ªçn game</label>
              <select id="game" class="form-select">
                <option value="">-- Ch·ªçn --</option>
                <option value="Li√™n Qu√¢n Mobile ADR">
                  Li√™n Qu√¢n Mobile ADR
                </option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="duration">Th·ªùi h·∫°n</label>
              <select id="duration" class="form-select">
                <option value="">-- Ch·ªçn --</option>
                <option value="1day">1 ng√†y (2.500ƒë)</option>
                <option value="7day">7 ng√†y (40.000ƒë)</option>
                <option value="30day">30 ng√†y (100.000ƒë)</option>
                <option value="30day">60 ng√†y (180.000ƒë)</option>
                <option value="30day">90 ng√†y (240.000ƒë)</option>
              </select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label" for="discountCode">M√£ gi·∫£m gi√°</label>
              <input
                id="discountCode"
                class="form-control"
                placeholder="GIAM10 / GIAM30"
              />
            </div>
            <div class="col-12 d-flex align-items-end">
              <button type="button" id="paymentButton" class="btn btn-success">
                Ti·∫øp t·ª•c thanh to√°n
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- MODAL THANH TO√ÅN -->
      <div
        class="modal fade"
        id="paymentModal"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div
            class="modal-content"
            style="
              background: #0b1220;
              color: #e2e8f0;
              border: 1px solid #1f2a44;
            "
          >
            <div class="modal-header">
              <h5 class="modal-title">Thanh to√°n & X√°c nh·∫≠n</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <div id="resultBox" class="mb-3"></div>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card p-3">
                    <div class="mb-2">
                      <div class="text-muted small">M√£ giao d·ªãch</div>
                      <div class="d-flex align-items-center">
                        <div id="note" class="me-2 fw-semibold"></div>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-light copy-btn"
                          data-target="note"
                        >
                          Copy
                        </button>
                      </div>
                    </div>
                    <div class="mb-2">
                      <div class="text-muted small">S·∫£n ph·∫©m</div>
                      <div id="product" class="fw-semibold"></div>
                    </div>
                    <div>
                      <div class="text-muted small">S·ªë ti·ªÅn</div>
                      <div id="amount" class="fw-semibold"></div>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card p-3 text-center">
                    <div class="mb-2">Qu√©t QR ƒë·ªÉ thanh to√°n</div>
                    <!-- ·∫£nh QR do JS c·ªßa b·∫°n set src -->
                    <img
                      id="qrImage"
                      alt="QR"
                      style="
                        max-width: 100%;
                        border-radius: 8px;
                        border: 1px solid #1f2a44;
                      "
                    />
                    <div class="mt-2">
                      <a
                        id="paymentLink"
                        class="btn btn-outline-info btn-sm"
                        target="_blank"
                        rel="noopener"
                      >
                        M·ªü trang MBBank
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" id="confirmBtn" class="btn btn-primary">
                T√¥i ƒë√£ thanh to√°n
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                ƒê√≥ng
              </button>
            </div>
          </div>
        </div>
      </div>

      <footer class="small text-muted mt-4">
        ¬© <span id="year"></span> Shop Key Game
      </footer>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const games = [
          {
            title: "Li√™n Qu√¢n Mobile ADR",
            image:
              "https://cdn-media.sforum.vn/storage/app/media/wp-content/uploads/2023/07/THUMB.jpg",
            links: [
              {
                text: "T·∫£i t√°ch g·ªëc",
                url: "https://www.mediafire.com/file/z8tqbiufur3uely/MAP2.9+FIX+V%C4%82NG+_+T%C3%81CH.apk/file",
              },
              {
                text: "T·∫£i x√≥a g·ªëc",
                url: "https://www.mediafire.com/file/28o2ln5md8h1oml/2.9+FIX+CRASH+(+L%E1%BA%A6N+2).apk/file",
              },
              { text: "L·∫•y Key Free", url: "https://link4m.com/u2Uqp" },
            ],
          },
        ];

        const discountCodes = {
          GIAM10: { value: 0.1, description: "Gi·∫£m 10%" },
          GIAM30: { value: 0.2, description: "Gi·∫£m 20%" },
          // FREE100: { value: 1, description: "Mi·ªÖn ph√≠" },
        };

        const priceConfig = {
          "1day": { amount: 2000, display: "1 ng√†y" },
          "7day": { amount: 40000, display: "7 ng√†y" },
          "30day": { amount: 100000, display: "30 ng√†y" },
          "60day": { amount: 180000, display: "60 ng√†y" },
          "90day": { amount: 240000, display: "90 ng√†y" },
        };
        const el = (id) => document.getElementById(id);
        const state = {
          modal: null,
          transaction: null,
          processing: false,
        };
        const renderGames = () => {
          const container = el("gameList");
          container.innerHTML = games
            .map(
              (game) => `
            <div class="game-card">
                <img src="${game.image}" alt="${
                game.title
              }" class="game-image" onerror="this.src='https://via.placeholder.com/180?text=Image+Not+Found'">
                <div class="game-content">
                    <h4 class="game-title">${game.title}</h4>
                    ${game.links
                      .map(
                        (link) =>
                          `<a href="${link.url}" ${
                            link.url !== "#" ? 'target="_blank"' : ""
                          } class="btn btn-primary game-btn">${link.text}</a>`
                      )
                      .join("")}
                </div>
            </div>
        `
            )
            .join("");
        };
        const applyDiscount = (code, amount) => {
          const dc = discountCodes[code];
          if (!dc)
            return {
              final: amount,
              msg: code ? `‚ö†Ô∏è M√£ gi·∫£m gi√° "${code}" kh√¥ng h·ª£p l·ªá.` : "",
            };
          const final = Math.max(0, Math.round(amount * (1 - dc.value)));
          return {
            final,
            msg: `‚úÖ M√£ gi·∫£m gi√° "${code}" (${dc.description}) ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng.`,
          };
        };

        // Update modal content with transaction details
        const updateModal = ({ code, product, amount, message }) => {
          el("note").textContent = code;
          el("product").textContent = product;
          el("amount").textContent = amount.toLocaleString("vi-VN") + " VNƒê";

          // Generate QR code URL based on transaction details
          el(
            "qrImage"
          ).src = `https://qr.sepay.vn/img?acc=075020699999&bank=MBBank&amount=${amount}&des=${code}&template=compact`;

          // Construct MBBank payment link
          el(
            "paymentLink"
          ).href = `https://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=075020699999&amount=${amount}&content=${encodeURIComponent(
            code
          )}`;

          // Display discount message
          el("resultBox").innerHTML = message
            ? `<div class="alert alert-${
                amount === 0 ? "warning" : "success"
              }">${message}</div>`
            : "";
        };

        // Generic SweetAlert2 alert function
        const showAlert = (icon, title, html) =>
          Swal.fire({ icon, title, html, confirmButtonColor: "#16a34a" });

        // Generic SweetAlert2 toast notification
        const showToast = (msg) =>
          Swal.fire({
            icon: "success",
            title: msg,
            toast: true,
            position: "top-end",
            timer: 2000,
            showConfirmButton: false,
          });

        // Handle payment button click
        const handlePayment = () => {
          if (state.processing) return; 
          state.processing = true;
          const game = el("game")?.value;
          const duration = el("duration")?.value;
          const discountCode = el("discountCode")?.value.trim().toUpperCase();
          const config = priceConfig[duration];
          if (!game || !config) {
            showAlert(
              "error",
              "Thi·∫øu th√¥ng tin!",
              "Vui l√≤ng ch·ªçn game v√† th·ªùi h·∫°n."
            );
            state.processing = false;
            return;
          }

          const discountResult = applyDiscount(discountCode, config.amount);
          const transCode = "DXK" + Math.floor(1000 + Math.random() * 9000); // Unique transaction code
          const product = `${config.display} | ${game}`;

          state.transaction = {
            code: transCode,
            product,
            amount: discountResult.final,
          };

          updateModal({
            code: transCode,
            product,
            amount: discountResult.final,
            message: discountResult.msg,
          });
          state.modal.show(); // Show the Bootstrap modal
          state.processing = false;
        };

        // Handle payment confirmation
        const confirmPayment = () => {
          if (!state.transaction || state.processing) return;
          state.processing = true;

          showAlert(
            "success",
            "üéâ Thanh to√°n th√†nh c√¥ng!",
            `M√£ giao d·ªãch: <strong>${state.transaction.code}</strong><br>Li√™n h√™Ã£ admin ƒë√™Ãâ l√¢ÃÅy key nheÃÅ!!`
          );
          el("resultBox").innerHTML =
            '<div class="alert alert-success">‚úÖ ƒê√£ x√°c nh·∫≠n thanh to√°n. Vui l√≤ng ƒë·ª£i admin x·ª≠ l√Ω.</div>';
          el("confirmBtn").disabled = true;
          setTimeout(() => {
            el("orderForm").reset();
            state.modal.hide();
            el("confirmBtn").disabled = false;
            state.transaction = null;
            state.processing = false;
            el("resultBox").innerHTML = "";
          }, 5000);
        };

        // Handle copy button clicks
        const handleCopy = (e) => {
          const btn = e.target.closest(".copy-btn");
          if (!btn) return;
          const textToCopy =
            btn.dataset.text || el(btn.dataset.target)?.textContent;
          if (!textToCopy) return;

          // Use modern clipboard API if available
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(textToCopy)
              .then(() => showToast("ƒê√£ sao ch√©p!"))
              .catch((err) => {
                console.error("Failed to copy text: ", err);
                showAlert(
                  "error",
                  "L·ªói sao ch√©p!",
                  "Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " +
                    textToCopy
                );
              });
          } else {
            // Fallback for older browsers
            const textarea = document.createElement("textarea");
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand("copy");
              showToast("ƒê√£ sao ch√©p!");
            } catch (err) {
              console.error("Fallback copy failed: ", err);
              showAlert(
                "error",
                "L·ªói sao ch√©p!",
                "Kh√¥ng th·ªÉ t·ª± ƒë·ªông sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: " +
                  textToCopy
              );
            }
            document.body.removeChild(textarea);
          }
        };

        // Initialize the page
        renderGames();
        document.getElementById("year").textContent = new Date().getFullYear();
        state.modal = new bootstrap.Modal(el("paymentModal")); // Initialize Bootstrap modal instance
        el("paymentButton").addEventListener("click", handlePayment);
        el("confirmBtn").addEventListener("click", confirmPayment);
        document.addEventListener("click", handleCopy); // Event delegation for copy buttons
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.getElementById("orderForm");
        if (form) form.addEventListener("submit", (e) => e.preventDefault());
      });
    </script>
  </body>
</html>
