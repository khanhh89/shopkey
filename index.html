<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Shop Key Game</title>

    <!-- Bootstrap & SweetAlert2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        background: #0f172a;
        color: #e2e8f0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .container-narrow {
        max-width: 880px;
      }
      .card {
        background: #0b1220;
        border: 1px solid #1f2a44;
        border-radius: 14px;
      }
      .game-card {
        display: grid;
        grid-template-columns: 180px 1fr;
        gap: 16px;
        padding: 12px;
        border: 1px solid #1f2a44;
        border-radius: 14px;
        background: #0b1220;
        margin-bottom: 14px;
      }
      .game-image {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #1f2a44;
      }
      .game-title {
        margin: 0 0 8px;
        color: #e2e8f0;
      }
      .game-btn {
        margin-right: 8px;
        margin-bottom: 8px;
      }
      .form-label {
        color: #cbd5e1;
      }
      .text-muted {
        color: #94a3b8 !important;
      }
      .btn-success {
        background: #16a34a;
        border: 0;
      }
      .btn-primary {
        background: #3b82f6;
        border: 0;
      }
      .bank-badge {
        display: inline-block;
        padding: 6px 10px;
        border: 1px solid #1f2a44;
        border-radius: 10px;
        margin-right: 6px;
        margin-bottom: 6px;
        font-size: 12px;
        color: #cbd5e1;
        background: #0b1220;
      }
      .small-dim {
        color: #93a4c0;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container container-narrow py-4">
      <header class="mb-4">
        <h1 class="h4 mb-1">Shop Key Game</h1>
        <div class="text-muted">Thanh toán QR • Nhận key nhanh</div>
      </header>

      <section class="mb-4">
        <h2 class="h6 mb-3">Game / Ứng dụng</h2>
        <div id="gameList"></div>
      </section>

      <section class="mb-5">
        <div class="card p-3">
          <form id="orderForm" class="row gy-3">
            <div class="col-12 col-md-6">
              <label class="form-label" for="game">Chọn game</label>
              <select id="game" class="form-select">
                <option value="">-- Chọn --</option>
                <option value="Liên Quân Mobile ADR">Liên Quân Mobile ADR</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="duration">Thời hạn</label>
              <select id="duration" class="form-select">
                <option value="">-- Chọn --</option>
                <option value="1day">1 ngày (2.000đ)</option>
                <option value="7day">7 ngày (40.000đ)</option>
                <option value="30day">30 ngày (100.000đ)</option>
                <option value="60day">60 ngày (180.000đ)</option>
                <option value="90day">90 ngày (240.000đ)</option>
              </select>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="bankApp">Chọn ngân hàng</label>
              <select id="bankApp" class="form-select">
                <option value="mb">MB Bank (khuyến nghị)</option>
                <option value="vcb">Vietcombank</option>
                <option value="bidv">BIDV</option>
                <option value="tcb">Techcombank</option>
                <option value="acb">ACB</option>
                <option value="vpb">VPBank</option>
                <option value="vtb">VietinBank</option>
                <option value="tpb">TPBank</option>
                <option value="scb">Sacombank</option>
                <option value="agb">Agribank</option>
              </select>
              <div class="small-dim mt-2">
                Hệ thống sẽ thử mở trực tiếp app. Nếu không được, hãy dùng nút/fallback hoặc quét QR.
              </div>
            </div>

            <div class="col-12 col-md-6">
              <label class="form-label" for="discountCode">Mã giảm giá</label>
              <input id="discountCode" class="form-control" placeholder="GIAM10 / GIAM20" />
            </div>

            <div class="col-12 d-flex align-items-end">
              <button type="button" id="paymentButton" class="btn btn-success">
                Tiếp tục thanh toán
              </button>
            </div>
          </form>
        </div>
      </section>

      <!-- MODAL THANH TOÁN -->
      <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg">
          <div
            class="modal-content"
            style="background: #0b1220; color: #e2e8f0; border: 1px solid #1f2a44"
          >
            <div class="modal-header">
              <h5 class="modal-title">Thanh toán & Xác nhận</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
                aria-label="Close"
              ></button>
            </div>

            <div class="modal-body">
              <div id="resultBox" class="mb-3"></div>

              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card p-3">
                    <div class="mb-2">
                      <div class="text-muted small">Mã giao dịch</div>
                      <div class="d-flex align-items-center">
                        <div id="note" class="me-2 fw-semibold"></div>
                        <button
                          type="button"
                          class="btn btn-sm btn-outline-light copy-btn"
                          data-target="note"
                        >
                          Copy
                        </button>
                      </div>
                    </div>

                    <div class="mb-2">
                      <div class="text-muted small">Sản phẩm</div>
                      <div id="product" class="fw-semibold"></div>
                    </div>

                    <div class="mb-3">
                      <div class="text-muted small">Số tiền</div>
                      <div id="amount" class="fw-semibold"></div>
                    </div>

                    <div>
                      <div class="text-muted small">Ngân hàng</div>
                      <div id="bankLabel" class="fw-semibold"></div>
                    </div>
                  </div>
                </div>

                <div class="col-md-6">
                  <div class="card p-3 text-center">
                    <div class="mb-2">Quét QR để thanh toán</div>
                    <img
                      id="qrImage"
                      alt="QR"
                      style="max-width: 100%; border-radius: 8px; border: 1px solid #1f2a44"
                    />
                    <div class="mt-2 d-grid gap-2">
                      <a
                        id="paymentLink"
                        class="btn btn-outline-info btn-sm"
                        target="_blank"
                        rel="noopener"
                      >
                        Mở bằng app đã chọn
                      </a>
                      <button id="retryOpenApp" class="btn btn-outline-light btn-sm" type="button">
                        Thử mở lại app
                      </button>
                      <div class="small-dim">
                        Nếu ứng dụng không mở, vui lòng dùng nút trên hoặc quét QR.
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="mt-3">
                <span class="bank-badge">Bảo lưu QR để dùng lại trong 5 phút</span>
                <span class="bank-badge">Nội dung chuyển khoản = Mã giao dịch</span>
                <span class="bank-badge">Sai số tiền hoặc sai nội dung có thể chậm xử lý</span>
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" id="confirmBtn" class="btn btn-primary">
                Tôi đã thanh toán
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Đóng
              </button>
            </div>
          </div>
        </div>
      </div>

      <footer class="small text-muted mt-4">
        © <span id="year"></span> Shop Key Game
      </footer>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        /*************** CẤU HÌNH TÀI KHOẢN & NGÂN HÀNG ***************/
        // Số tài khoản nhận tiền
        const ACCOUNT_NO = "075020699999";
        const ACCOUNT_BANK_CODE = "MBBank";
        const BANK_DISPLAY = {
          mb: "MB Bank",
          vcb: "Vietcombank",
          bidv: "BIDV",
          tcb: "Techcombank",
          acb: "ACB",
          vpb: "VPBank",
          vtb: "VietinBank",
          tpb: "TPBank",
          scb: "Sacombank",
          agb: "Agribank",
        };
        const VIETQR_APP = {
          mb: "mb",
          vcb: "vcb",
          bidv: "bidv",
          tcb: "techcombank",
          acb: "acb",
          vpb: "vpbank",
          vtb: "vietinbank",
          tpb: "tpbank",
          scb: "sacombank",
          agb: "agribank",
        };
        const MB_ANDROID_PKG = "com.mbmobile";

        const games = [
          {
            title: "Liên Quân Mobile ADR",
            image:
              "https://cdn-media.sforum.vn/storage/app/media/wp-content/uploads/2023/07/THUMB.jpg",
            links: [
              {
                text: "Tải tách gốc",
                url: "https://www.mediafire.com/file/z8tqbiufur3uely/MAP2.9+FIX+V%C4%82NG+_+T%C3%81CH.apk/file",
              },
              {
                text: "Tải xóa gốc",
                url: "https://www.mediafire.com/file/28o2ln5md8h1oml/2.9+FIX+CRASH+(+L%E1%BA%A6N+2).apk/file",
              },
              {
                text: "Tải IPA IOS",
                url: "https://chaptodocquyen.appinstall.cloud/aovcheatipa.ipa",
              { text: "Lấy Key Free", url: "https://link4m.com/hP9L1U" },
            ],
          },
        ];

        const discountCodes = {
          GIAM10: { value: 0.1, description: "Giảm 10%" },
          GIAM20: { value: 0.2, description: "Giảm 20%" },
        };

        const priceConfig = {
          "1day": { amount: 2000, display: "1 ngày" },
          "7day": { amount: 40000, display: "7 ngày" },
          "30day": { amount: 100000, display: "30 ngày" },
          "60day": { amount: 180000, display: "60 ngày" },
          "90day": { amount: 240000, display: "90 ngày" },
        };

        /******************** TIỆN ÍCH ********************/
        const el = (id) => document.getElementById(id);
        const isAndroid = /Android/i.test(navigator.userAgent);
        const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);

        const state = {
          modal: null,
          transaction: null,
          processing: false,
        };

        const showAlert = (icon, title, html) =>
          Swal.fire({ icon, title, html, confirmButtonColor: "#16a34a" });

        const showToast = (msg) =>
          Swal.fire({
            icon: "success",
            title: msg,
            toast: true,
            position: "top-end",
            timer: 2000,
            showConfirmButton: false,
          });

        const applyDiscount = (code, amount) => {
          const dc = discountCodes[code];
          if (!dc)
            return {
              final: amount,
              msg: code ? `⚠️ Mã giảm giá "${code}" không hợp lệ.` : "",
            };
          const final = Math.max(0, Math.round(amount * (1 - dc.value)));
          return {
            final,
            msg: `✅ Mã giảm giá "${code}" (${dc.description}) đã được áp dụng.`,
          };
        };

        const renderGames = () => {
          const container = el("gameList");
          container.innerHTML = games
            .map(
              (game) => `
              <div class="game-card">
                <img src="${game.image}" alt="${
                  game.title
                }" class="game-image" onerror="this.src='https://via.placeholder.com/180?text=Image+Not+Found'">
                <div class="game-content">
                  <h4 class="game-title">${game.title}</h4>
                  ${game.links
                    .map(
                      (link) =>
                        `<a href="${link.url}" ${
                          link.url !== "#" ? 'target="_blank"' : ""
                        } class="btn btn-primary game-btn">${link.text}</a>`
                    )
                    .join("")}
                </div>
              </div>`
            )
            .join("");
        };

        /******************** DEEPLINK BUILDER ********************/
        // Link web MBBank (có thể là universal link trên iOS)
        const buildMBWeb = (amount, code) =>
          `https://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=${ACCOUNT_NO}&amount=${amount}&content=${encodeURIComponent(
            code
          )}`;

        // Android Intent mở thẳng app MB
        const buildMBIntent = (amount, code) =>
          `intent://mbbank.com.vn/QRTransfer?bankId=MB&accountNo=${ACCOUNT_NO}&amount=${amount}&content=${encodeURIComponent(
            code
          )}#Intent;scheme=https;package=${MB_ANDROID_PKG};end`;

        // VietQR Deeplink: điều hướng tới app ngân hàng tương ứng (nếu hỗ trợ)
        // Lưu ý: nếu app chưa cài, có thể không mở được — UI đã có QR và nút mở lại.
        const buildVietQRLink = (appCode, amount, code) =>
          `https://dl.vietqr.io/pay?app=${appCode}&acc=${ACCOUNT_NO}&amount=${amount}&note=${encodeURIComponent(
            code
          )}`;

        // Ảnh QR (mã nội dung: code, số tiền: amount)
        // Bạn có thể đổi sang img.vietqr.io nếu muốn.
        const buildQRImage = (amount, code) =>
          `https://qr.sepay.vn/img?acc=${ACCOUNT_NO}&bank=${encodeURIComponent(
            ACCOUNT_BANK_CODE
          )}&amount=${amount}&des=${encodeURIComponent(
            code
          )}&template=compact`;

        // Nhãn đẹp cho ngân hàng
        const labelOfBank = (bankKey) => BANK_DISPLAY[bankKey] || "Ngân hàng khác";

        // Mở app theo lựa chọn người dùng
        function openBankApp({ bankKey, amount, code, auto = false }) {
          const a = el("paymentLink");
          let href = "#";

          if (bankKey === "mb") {
            const baseWeb = buildMBWeb(amount, code);
            const androidIntent = buildMBIntent(amount, code);
            href = baseWeb; // đặt cho nút

            if (auto && (isAndroid || isIOS)) {
              if (isAndroid) {
                // Thử Intent -> fallback web
                window.location.href = androidIntent;
                setTimeout(() => {
                  try {
                    window.location.href = baseWeb;
                  } catch (_) {}
                }, 1200);
              } else {
                // iOS: mở universal link (nếu app hỗ trợ sẽ vào app, nếu không thì web)
                window.location.href = baseWeb;
              }
            }
          } else {
            const appCode = VIETQR_APP[bankKey] || "mb";
            const vietqr = buildVietQRLink(appCode, amount, code);
            href = vietqr;

            if (auto && (isAndroid || isIOS)) {
              // Thử mở app qua VietQR deeplink
              window.location.href = vietqr;
              // Không bắt buộc fallback ở đây vì người dùng vẫn đang ở modal và có QR sẵn
            }
          }

          a.href = href; // luôn gán để user có thể bấm lại
        }

        /******************** UI CẬP NHẬT MODAL ********************/
        function updateModal({ code, product, amount, bankKey, message }) {
          el("note").textContent = code;
          el("product").textContent = product;
          el("amount").textContent = amount.toLocaleString("vi-VN") + " VNĐ";
          el("bankLabel").textContent = labelOfBank(bankKey);

          // Set QR image
          el("qrImage").src = buildQRImage(amount, code);

          // Thông báo áp mã giảm giá (nếu có)
          el("resultBox").innerHTML = message
            ? `<div class="alert alert-${
                amount === 0 ? "warning" : "success"
              }">${message}</div>`
            : "";
          openBankApp({ bankKey, amount, code, auto: false });
        }
        function handlePayment() {
          if (state.processing) return;
          state.processing = true;

          const game = el("game")?.value;
          const duration = el("duration")?.value;
          const bankKey = el("bankApp")?.value || "mb";
          const discountCode = el("discountCode")?.value.trim().toUpperCase();
          const config = priceConfig[duration];

          if (!game || !config) {
            showAlert("error", "Thiếu thông tin!", "Vui lòng chọn game và thời hạn.");
            state.processing = false;
            return;
          }

          const discountResult = applyDiscount(discountCode, config.amount);
          const transCode = "DXK" + Math.floor(1000 + Math.random() * 9000);
          const product = `${config.display} | ${game}`;

          state.transaction = {
            code: transCode,
            product,
            amount: discountResult.final,
            bankKey,
          };
          updateModal({
            code: transCode,
            product,
            amount: discountResult.final,
            bankKey,
            message: discountResult.msg,
          });

          state.modal.show();
          openBankApp({
            bankKey,
            amount: discountResult.final,
            code: transCode,
            auto: true,
          });

          state.processing = false;
        }

        function confirmPayment() {
          if (!state.transaction || state.processing) return;
          state.processing = true;

          showAlert(
            "success",
            "🎉 Thanh toán thành công!",
            `Mã giao dịch: <strong>${state.transaction.code}</strong><br>Liên hệ admin để lấy key nhé!`
          );

          el("resultBox").innerHTML =
            '<div class="alert alert-success">✅ Đã xác nhận thanh toán. Vui lòng đợi admin xử lý.</div>';
          el("confirmBtn").disabled = true;

          setTimeout(() => {
            el("orderForm").reset();
            state.modal.hide();
            el("confirmBtn").disabled = false;
            state.transaction = null;
            state.processing = false;
            el("resultBox").innerHTML = "";
          }, 5000);
        }

        function handleCopy(e) {
          const btn = e.target.closest(".copy-btn");
          if (!btn) return;
          const textToCopy = btn.dataset.text || el(btn.dataset.target)?.textContent;
          if (!textToCopy) return;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(textToCopy)
              .then(() => showToast("Đã sao chép!"))
              .catch((err) => {
                console.error("Failed to copy text: ", err);
                showAlert(
                  "error",
                  "Lỗi sao chép!",
                  "Không thể tự động sao chép. Vui lòng sao chép thủ công: " + textToCopy
                );
              });
          } else {
            const textarea = document.createElement("textarea");
            textarea.value = textToCopy;
            document.body.appendChild(textarea);
            textarea.select();
            try {
              document.execCommand("copy");
              showToast("Đã sao chép!");
            } catch (err) {
              console.error("Fallback copy failed: ", err);
              showAlert(
                "error",
                "Lỗi sao chép!",
                "Không thể tự động sao chép. Vui lòng sao chép thủ công: " + textToCopy
              );
            }
            document.body.removeChild(textarea);
          }
        }

        function retryOpen() {
          if (!state.transaction) return;
          openBankApp({
            bankKey: state.transaction.bankKey,
            amount: state.transaction.amount,
            code: state.transaction.code,
            auto: true,
          });
        }
        renderGames();
        document.getElementById("year").textContent = new Date().getFullYear();

        state.modal = new bootstrap.Modal(el("paymentModal"));
        el("paymentButton").addEventListener("click", handlePayment);
        el("confirmBtn").addEventListener("click", confirmPayment);
        el("retryOpenApp").addEventListener("click", retryOpen);
        document.addEventListener("click", handleCopy);
        const form = document.getElementById("orderForm");
        if (form) form.addEventListener("submit", (e) => e.preventDefault());
      });
    </script>
  </body>
</html>
